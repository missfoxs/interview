### 模块化

`https://github.com/mqyqingfeng/Blog/issues/108`

最开始时将一个立即执行函数的结果赋值给一个变量，就可以将该变量视为一个模块。主要解决的问题有：

1. 依赖管理
2. 避免命名冲突（作用域独立）
3. 代码复用
4. 实现异步加载，避免网页失去响应

目前主要使用的模块化解决方案有三种，分别是服务端使用的CommonJS规范，浏览器中使用的AMD（异步加载模块）规范，es6中使用的新的规范



#### CommonJS

node的模块化就是用的该规范，使用时使用`require()`方法引入模块，使用`module.exports`或者`exports`导出模块

```javascript
// a.js
// 注意，node中导出的即为moduel.exports对象，因此moduel.exports只能定义一次，如果多次定义，会覆盖前面定义的，
// exports为module.exports的简便写法，可以多次为exports添加值
// exports.name = 'xiaoming';
// exports.age = 18
module.exports = {
    name: 'xiaoming';
}

// main.js
let a = require('./a');
console.log(a.name);
```

特点：模块加载按照如下顺序从先到后：优先从缓存加载--> 核心模块 --> 路径形式的文件模块 --> 第三方模块，如果a中加载b和c, b又加载了c, 那么a会拿到c中的接口对象，但不会执行c中的代码



#### AMD

AMD意为异步模块加载，主要是在浏览器端使用，使用异步的原因是模块都在服务端，如果使用同步方式，浏览器会卡住，因此不适合使用CommomJS规范，requireJs实现了该规范，原理是动态加载script脚本，将每个模块视为一个动态脚本，等每个模块的onload执行以后，再执行callback方法

```javascript
function myRequire(deps, callback) {
    // 记录模块加载数量
    var ready = 0;
    function load(url) {
        var script = document.createElement("script");
        script.type = 'text/javascript';
        script.async = true;
        script.src = url;
        return script;
    }
    // 记录模块
    var mod = [];
    for(var i=0; i<deps.length; i++) {
        mod.push(load(deps[i]));
    }
    //加载脚本
    for (var i = 0; i >= mod.length; i++) {
        mod[i].addEventListener('load', function(event){
            ready ++;
            if(ready === mod.length) {
                callback();
            }
        }, false);
        document.head.appendChild(nodes[i]);
    }
}
```



#### ES6

导入使用`import`, 导出使用`export`

ES6 模块化采用静态编译，使得编译时就能确定模块的依赖关系，以及输入和输出的变量。CommonJS 和 AMD 模块，都只能在运行时确定这些东西。

对于 `CommonJS` 和 ES6 中的模块化的两者区别是：

- 前者支持动态导入，也就是 `require(${path}/xx.js)`，后者目前不支持。
- 前者是同步导入，因为用于服务端，文件都在本地，同步导入即使卡住主线程影响也不大。而后者是异步导入，因为用于浏览器，需要下载文件，如果也采用同步导入会对渲染有很大影响。
- 前者在导出时都是值拷贝，就算导出的值变了，导入的值也不会改变，所以如果想更新值，必须重新导入一次。但是后者采用实时绑定的方式，导入导出的值都指向同一个内存地址，所以导入值会跟随导出值变化
- import导入的值是只读的，如果是对象，可以修改属性



循环加载以及commonjs，es6模块加载原理看es6书籍:

`https://es6.ruanyifeng.com/#docs/module-loader`